<link href="__PUBLIC__/Back/metronic/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/Back/metronic/assets/global/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css" rel="stylesheet" type="text/css">
<div class="portlet light bordered">
	<div class="portlet-title">
		<div class="caption">
			<i class="fa fa-plus font-red"></i>
			<span class="caption-subject font-red uppercase">添加餐品</span>
		</div>
		<div class="actions">

		</div>
	</div>
	<div class="portlet-body form">
		<form action="__URL__/editGoodsAction" class="form-horizontal" id="tform" method="post" enctype="multipart/form-data">
			<div class="form-body">
				<div class="row">
					<div class="col-md-12">
						<div class="form-group last">
							<label class="control-label col-md-3">图片</label>
							<div class="col-md-9">
								<div class="fileinput fileinput-new" data-provides="fileinput">
									<div class="fileinput-new thumbnail" style="width: 200px; height: 150px;">
										<empty name="data['img']">
										<img src="__PUBLIC__/Back/metronic/img/noimage.jpg" alt="" />
										<else />
										<img src="{$Think.config.OSS_PATH}{$data['img']}" alt="" />
										</empty>
									</div>
									<div class="fileinput-preview fileinput-exists thumbnail" style="max-width: 400px; max-height: 400px;"> </div>
									<div>
										<span class="btn default btn-file">
                                    <span class="fileinput-new"> 选择图片 </span>
										<span class="fileinput-exists"> 变更 </span>
										<input type="file" name="img" id="gimg"> </span>
										<a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> 清除 </a>
									</div>
								</div>
								<div class="clearfix margin-top-10">
									<span class="label label-warning">说明</span> 图片尺寸建议为400x400或正方形图片 </div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">名称</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="name" placeholder="" value="{$data['name']}" require="true">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

				<if condition="$has_barcode eq 1">
				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">条形码</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="barcode" placeholder="" value="{$data['barcode']}">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>
				</if>

				<!--/row-->
				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">成本价</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="input_price" placeholder="非必填" value="{$data['input_price']}">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>
				<!-- <div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">零售价</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="price" value="{$data['price']}" placeholder="" require="true">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">活动价</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="discount_price" value="{$data['discount_price']}" placeholder="">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">使用餐盒数</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="lunchbox_num" value="{$data['lunchbox_num']}" placeholder="">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">餐盒单价</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="lunchbox_price" value="{$data['lunchbox_price']}" placeholder="">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div> -->


				<div class="row">
					<label class="control-label col-md-3">商品规格</label>
					<div class="good-type-box col-md-9 row">
						<div class="good-type">
							<empty name="goods_format">
							<div class="col-md-3 hide">
							<else />
							<div class="col-md-3">
							</empty>
								<label for="" class="control-label">规格名称</label>
								<input type="text" class="form-control" placeholder="例如：大份" name="f_name[]" value="{$data['f_name']}"><input type="hidden" name="format_id[]" value="0"> </div>
							<div class="col-md-3">
								<label for="" class="control-label">价格</label>
								<input type="text" class="form-control" placeholder="" name="price[]" value="{$data['price']}"> </div>
							<div class="col-md-3">
								<label for="" class="control-label">活动价</label>
								<input type="text" class="form-control" placeholder="" name="discount_price[]" value="{$data['discount_price']}"> </div>
							<div class="col-md-2">
								<label for="" class="control-label">餐盒数</label>
								<input type="text" class="form-control" placeholder="" name="lunchbox_num[]" value="{$data['lunchbox_num']}"> </div>
							<div class="col-md-2">
								<label for="" class="control-label">餐盒单价</label>
								<input type="text" class="form-control" placeholder="" name="lunchbox_price[]" value="{$data['lunchbox_price']}"> </div>
							<!-- <div class="col-md-2">
								<label for="" class="control-label">操作</label><br />
								<button class="btn btn-default good-type-del" type="button">删除</button>
							</div> -->
							<div class="col-md-12">
								<span class="help-block"></span>
							</div>
						</div>

						<volist name="goods_format" id="item">
						<div class="good-type">
							<div class="col-md-3">
								<label for="" class="control-label">规格名称</label>
								<input type="text" class="form-control" placeholder="例如：大份" name="f_name[]" value="{$item['f_name']}"><input type="hidden" name="format_id[]" value="{$item['id']}"> </div>
							<div class="col-md-3">
								<label for="" class="control-label">价格</label>
								<input type="text" class="form-control" placeholder="" name="price[]" value="{$item['f_price']}"> </div>
							<div class="col-md-3">
								<label for="" class="control-label">活动价</label>
								<input type="text" class="form-control" placeholder="" name="discount_price[]" value="{$item['discount_price']}"> </div>
							<div class="col-md-2">
								<label for="" class="control-label">餐盒数</label>
								<input type="text" class="form-control" placeholder="" name="lunchbox_num[]" value="{$item['labelunchbox_num']}"> </div>
							<div class="col-md-2">
								<label for="" class="control-label">餐盒单价</label>
								<input type="text" class="form-control" placeholder="" name="lunchbox_price[]" value="{$item['lunchbox_price']}"> </div>
							<div class="col-md-2">
								<label for="" class="control-label">操作</label><br />
								<button class="btn btn-default good-type-del" data-format="{$item['id']}" type="button">删除</button>
							</div>
							<div class="col-md-12">
								<span class="help-block"></span>
							</div>
						</div>
						</volist>
					</div>

				</div>
				<div class="row">
					<label class="control-label col-md-3"></label>
					<div class="col-md-4">
						<button class="btn btn-success good-type-add" type="button">添加规格</button>

						<div class="col-md-12">
							<span class="help-block"></span>
						</div>
					</div>

				</div>

				<div class="row" style="margin-top: 20px;">

					<label class="control-label col-md-3">商品属性</label>
					<div class="good-attr-box col-md-9 row">
						<volist name="goods_attr" id="item">
						<div class="good-attr">
							<div class="col-md-3">
								<label for="" class="control-label">属性名称</label>
								<input type="text" class="form-control" placeholder="例如：口味" name="goods_attr_name[]" value="{$item['name']}">
								<input type="hidden" name="attr_id[]" value="{$item['id']}">
							</div>
							<div class="col-md-7">
								<div for="" class="control-label" style="text-align: left;">属性</div>
								<input type="text" class="form-control" value="{$item['content']}" data-role="tagsinput" placeholder="例如：微辣、麻辣" name="goods_attr_content[]">
							</div>
							<div class="col-md-2">
								<label for="" class="control-label">操作</label><br /><button class="btn btn-default good-attr-del" data-attr="{$item['id']}" type="button">删除</button>
							</div>
							<div class="col-md-12">
								<span class="help-block"></span>
							</div>
						</div>
						</volist>
					</div>
				</div>
				<div class="row">
					<label class="control-label col-md-3"></label>
					<div class="col-md-4">
						<button class="btn btn-success good-attr-add" type="button">添加属性</button>

						<div class="col-md-12">
							<span class="help-block"></span>
						</div>
					</div>

				</div>

				<div class="row" style="">
					<div class="col-md-12">
						<div class="form-group">
                            <label class="control-label col-md-3">扩展属性</label>
                            <div class="col-md-4">
                                <input type="text" class="form-control" name="attrs" value="{$data['attrs']}"> </div>
                        </div>

					</div>
				</div>

				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">排序</label>
							<div class="col-md-4">
								<input type="text" class="form-control" name="sort" placeholder="" value="{$data['sort']}" require="true" readonly="readonly">
								<input id="basegoods_id" name="id" type="hidden" value="{$data['id']}">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">类型</label>
							<div class="col-md-4">
								<input type="text" class="form-control" value="{$data['category_name']}" placeholder="" readonly="readonly">
								<input type="hidden" name="category_id" value="{$data['category_id']}">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">标签</label>
							<div class="col-md-6">
								<input type="text" class="form-control" data-role="tagsinput" name="tags" value="{$data['tags']}" placeholder="微信端显示在名称旁，点击回车键可分隔多个小标签（非必填）">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>


				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">简介</label>
							<div class="col-md-6">
								<textarea cols="15" rows="5" class="form-control" name="summary" placeholder="微信端显示在名称下方，灰色小字（非必填）">{$data['summary']}</textarea>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">餐品详情</label>
							<div class="col-md-6">
								<textarea id="content" name="goods_detail" placeholder="">
									{$data['goods_detail']}
								</textarea>
							</div>
						</div>
					</div>
				</div>

				<div class="row">
					<label class="control-label col-md-3">详情图片</label>
					<div class="col-md-9 row">
						<div class="good-type">
							<div class="col-md-3 detail_img_box">
								<label for="" class="control-label"></label>
								<div class="fileinput fileinput-new" data-provides="fileinput">
									<div class="fileinput-new thumbnail" style="width: 100px; height: 100px;">
										<empty name="data.detail_img1">
										<img src="__PUBLIC__/Back/metronic/img/noimage.jpg" alt="" />
										<else />
										<img src="{$Think.config.OSS_PATH}{$data['detail_img1']}" alt="" />
										</empty>
										<input type="hidden" name="detail_img1" class="hidden_img" value="{$data['detail_img1']}">
									</div>
									<div class="fileinput-preview fileinput-exists thumbnail" style="width: 100px; height: 100px;"> </div>

									<div class="detail_img_select_box" <notempty name="data['detail_img1']">style="display:none;"</notempty>>
										<span class="btn default btn-file">
	                                <span class="fileinput-new"> 选择图片 </span>
										<span class="fileinput-exists"> 变更 </span>
										<input type="file" name="detail_img1" id="detail_img1"> </span>
										<a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> 清除 </a>
									</div>

									<div <empty name="data['detail_img1']">style="display:none;"</empty>>
										<a href="javascript:;" class="btn red" onclick="deleteDetailImg(this)"> 删除 </a>
									</div>
								</div>	
							</div>
							<div class="col-md-3 detail_img_box">
								<label for="" class="control-label"></label>
								<div class="fileinput fileinput-new" data-provides="fileinput">
									<div class="fileinput-new thumbnail" style="width: 100px; height: 100px;">
										<empty name="data.detail_img2">
										<img src="__PUBLIC__/Back/metronic/img/noimage.jpg" alt="" />
										<else />
										<img src="{$Think.config.OSS_PATH}{$data['detail_img2']}" alt="" />
										</empty>
										<input type="hidden" name="detail_img2" class="hidden_img" value="{$data['detail_img2']}">
									</div>
									<div class="fileinput-preview fileinput-exists thumbnail" style="width: 100px; height: 100px;"> </div>

									<div class="detail_img_select_box" <notempty name="data['detail_img2']">style="display:none;"</notempty>>
										<span class="btn default btn-file">
	                                <span class="fileinput-new"> 选择图片 </span>
										<span class="fileinput-exists"> 变更 </span>
										<input type="file" name="detail_img2" id="detail_img2"> </span>
										<a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> 清除 </a>
									</div>

									<div <empty name="data['detail_img2']">style="display:none;"</empty>>
										<a href="javascript:;" class="btn red" onclick="deleteDetailImg(this)"> 删除 </a>
									</div>
								</div>	
							</div>
							<div class="col-md-3 detail_img_box">
								<label for="" class="control-label"></label>
								<div class="fileinput fileinput-new" data-provides="fileinput">
									<div class="fileinput-new thumbnail" style="width: 100px; height: 100px;">
										<empty name="data.detail_img3">
										<img src="__PUBLIC__/Back/metronic/img/noimage.jpg" alt="" />
										<else />
										<img src="{$Think.config.OSS_PATH}{$data['detail_img3']}" alt="" />
										</empty>
										<input type="hidden" name="detail_img3" class="hidden_img" value="{$data['detail_img3']}">
									</div>
									<div class="fileinput-preview fileinput-exists thumbnail" style="width: 100px; height: 100px;"> </div>

									<div class="detail_img_select_box" <notempty name="data['detail_img3']">style="display:none;"</notempty>>
										<span class="btn default btn-file">
	                                <span class="fileinput-new"> 选择图片 </span>
										<span class="fileinput-exists"> 变更 </span>
										<input type="file" name="detail_img3" id="detail_img3"> </span>
										<a href="javascript:;" class="btn red fileinput-exists" data-dismiss="fileinput"> 清除 </a>
									</div>

									<div <empty name="data['detail_img3']">style="display:none;"</empty>>
										<a href="javascript:;" class="btn red" onclick="deleteDetailImg(this)"> 删除 </a>
									</div>
								</div>	
							</div>
							<div class="col-md-12">
								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="row" style="display:none">
					<div class="col-md-12">
						<div class="form-group">
							<label class="control-label col-md-3">适用门店</label>
							<div class="col-md-9">
								<div class="checkbox-list hd-shopsel">
								<label class="checkbox-inline">
		                    <input class="allchk" type="checkbox"> 全部 </label>
								<volist name="shop_list" id="item">
									<label class="checkbox-inline">
		                    <input type="checkbox" class="shop_id" name="shop_id[]" value="{$item['id']}" checked="checked"> {$item['name']} </label>
		                    	</volist>
								</div>

								<span class="help-block"></span>
							</div>
						</div>
					</div>
				</div>

			</div>
			<div class="form-actions">
				<div class="row">
					<div class="col-md-6">
						<div class="row">
							<div class="col-md-offset-3 col-md-9">
								<a href="javascript:;" class="btn green" onclick="save()">保存</a>
							</div>
						</div>
					</div>
					<div class="col-md-6"> </div>
				</div>
			</div>
		</form>
	</div>
</div>
<script src="__PUBLIC__/Back/metronic/assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
<script src="__PUBLIC__/Back/metronic/assets/global/plugins/bootstrap-tagsinput/bootstrap-tagsinput.min.js" type="text/javascript"></script>
<script src="__PUBLIC__/Back/metronic/assets/global/plugins/bootbox/bootbox.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/Public/ueditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="/Public/ueditor/ueditor.all.js"></script>
<!-- 实例化编辑器 -->
<script type="text/javascript">
	var ue = UE.getEditor('content');
	function save(){
		if(checkForm('tform')){
			<empty name="data['img']">
			/*if($('#gimg').val() == ''){
				alert("商品图片不能为空");
				return false;
			}
			var size = findSize("gimg");
			if(size > 800){
				alert("图片不能大于500KB");
				return false;
			}*/
			</empty>
			$("#tform").submit();
		}
	}

	$("#gimg").on('change',function(){
		var size = findSize("gimg");
		if(size > 800){
			alert("图片不能大于500KB");
		}
	});

	function findSize(field_id) {
		var fileInput = $("#"+field_id)[0];
		byteSize  = fileInput.files[0].size;
		return ( Math.ceil(byteSize / 1024) ); // Size returned in KB.
	}
</script>
<script type="text/javascript">
	
	//添加规格
	bootbox.setDefaults("locale","zh_CN");
	$('.good-type-add').on('click', function() {
		var htmltpl = '<div class="good-type"><div class="col-md-3"><label for="" class="control-label">规格名称</label><input type="text" class="form-control" placeholder="例如：大份" name="f_name[]"><input type="hidden" name="format_id[]" value="0"></div><div class="col-md-3"><label for="" class="control-label">价格</label><input type="text" class="form-control" placeholder="" name="price[]"></div><div class="col-md-3"><label for="" class="control-label">活动价</label><input type="text" class="form-control" placeholder="" name="discount_price[]"></div><div class="col-md-2"><label for="" class="control-label">餐盒数</label><input type="text" class="form-control" placeholder="" name="lunchbox_num[]"></div><div class="col-md-2"><label for="" class="control-label">餐盒单价</label><input type="text" class="form-control" placeholder="" name="lunchbox_price[]"></div><div class="col-md-2"><label for="" class="control-label">操作</label><br /><button class="btn btn-default good-type-del" type="button">删除</button></div><div class="col-md-12"><span class="help-block"></span></div></div>';
		$('.good-type-box').append(htmltpl);
		$('.good-type-box .col-md-3').eq(0).removeClass('hide')
		htmltpl = '';
	});
	$('body').on('click', '.good-type-box .good-type-del', function() {
		if($('.good-type').length == 1) {
			bootbox.setLocale("zh_CN");
			bootbox.alert("请至少保留一中规格")
		} else {
			var _this=$(this);
			bootbox.confirm({
				size: "small",
				message: "确认删除吗？",
				callback: function(result) {
					
					if(result) {
						var format_id = _this.attr('data-format');
						if(format_id != undefined){
							$.post('__URL__/deleteGoodsFormat',{format_id:format_id},function(res){
							})
						}
						_this.parents('.good-type').remove();
						if($('.good-type').length == 1){
							$('.good-type-box .col-md-3').eq(0).addClass('hide')
						}
						bootbox.alert("删除成功");
					}
				}
			});
		}
	})

	//添加属性
	$('.good-attr-add').on('click', function() {
		var htmltpl = '<div class="good-attr"><div class="col-md-3"><label for="" class="control-label">属性名称</label><input type="text" class="form-control" placeholder="例如：口味" name="goods_attr_name[]"><input type="hidden" name="attr_id[]" value="0"> </div><div class="col-md-7"><div for="" class="control-label" style="text-align: left;">属性</div><input type="text" class="form-control" value="" data-role="tagsinput" placeholder="例如：微辣、麻辣" name="goods_attr_content[]"></div><div class="col-md-2"><label for="" class="control-label">操作</label><br /><button class="btn btn-default good-attr-del" type="button">删除</button></div><div class="col-md-12"><span class="help-block"></span></div></div>';

		$('.good-attr-box').append(htmltpl);
		console.log(htmltpl)
		$('.good-attr-box').find('[data-role="tagsinput"]').tagsinput('refresh');
		htmltpl = '';
	});
	$('body').on('click', '.good-attr-box .good-attr-del', function() {
		var _this=$(this);
		bootbox.confirm({
			size: "small",
			message: "确认删除吗？",
			callback: function(result) {
				if(result) {
					var attr_id = _this.attr('data-attr');
					if(attr_id != undefined){
						$.post('__URL__/deleteGoodsAttr',{attr_id:attr_id},function(res){
						})
					}
					_this.parents('.good-attr').remove();
					bootbox.alert("删除成功");
				}
			}
		});
	})

	function deleteDetailImg(obj){
		var father_div = $(obj).closest(".detail_img_box");
		father_div.find('.detail_img_select_box').show();
		father_div.find('img').attr('src','');
		father_div.find('.hidden_img').val('');
		$(obj).remove();
	}
</script>